<script>
    document.addEventListener("DOMContentLoaded", function (event) {
        // Service B1 processing bar (fills left-to-right while "working")
        anime({
            targets: '#pipeline-viz .process-b1',
            width: [0, 116],
            easing: 'easeInOutSine',
            duration: 2000,
            direction: 'alternate',
            loop: true
        });

        // Service B2 processing bar
        anime({
            targets: '#pipeline-viz .process-b2',
            width: [0, 116],
            easing: 'easeInOutSine',
            duration: 2400,
            direction: 'alternate',
            loop: true,
            delay: 1300
        });

        // Lag build-up on T1 partition 2 (Service B2 is busy)
        anime({
            targets: '#pipeline-viz .lag-a2',
            height: [0, 16, 16, 0],
            y: [102, 86, 86, 102],
            easing: 'easeInOutSine',
            duration: 12000,
            loop: true,
            delay: 3000
        });
        anime({
            targets: '#pipeline-viz .lag-a2',
            fill: ['rgba(255,255,255,0.05)', 'rgba(255,180,80,0.6)', 'rgba(255,100,60,0.7)', 'rgba(255,255,255,0.05)'],
            easing: 'easeInOutSine',
            duration: 12000,
            loop: true,
            delay: 3000
        });

        // Lag on T2 partition 3
        anime({
            targets: '#pipeline-viz .lag-b3',
            height: [0, 16, 0],
            y: [254, 238, 254],
            easing: 'easeInOutSine',
            duration: 8000,
            loop: true,
            delay: 6000
        });
        anime({
            targets: '#pipeline-viz .lag-b3',
            fill: ['rgba(255,255,255,0.05)', 'rgba(255,180,80,0.5)', 'rgba(255,255,255,0.05)'],
            easing: 'easeInOutSine',
            duration: 8000,
            loop: true,
            delay: 6000
        });
    });
</script>

<svg id="pipeline-viz" width="290" height="348" viewBox="0 0 290 348" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <path id="route-p0" d="M 145,38 L 100,93 C 100,120 75,135 75,169 C 75,200 100,222 100,245 L 145,304"/>
        <path id="route-p1" d="M 145,38 L 128,93 C 128,120 75,135 75,169 C 75,200 128,222 128,245 L 145,304"/>
        <path id="route-p2" d="M 145,38 L 156,93 C 156,120 215,135 215,169 C 215,200 156,222 156,245 L 145,304"/>
        <path id="route-p3" d="M 145,38 L 184,93 C 184,120 215,135 215,169 C 215,200 184,222 184,245 L 145,304"/>
    </defs>

    <!-- ===== STATIC LAYOUT ===== -->

    <!-- Producer A -->
    <rect x="78" y="4" width="134" height="34" rx="4" fill="rgba(255,255,255,0.25)" stroke="rgba(255,255,255,0.6)" stroke-width="2"/>
    <text x="145" y="26" text-anchor="middle" fill="rgba(255,255,255,0.65)" font-size="13" font-family="Arial, sans-serif">Producer A</text>

    <!-- Fan-out: Producer → T1 partitions -->
    <line x1="145" y1="38" x2="100" y2="84" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
    <line x1="145" y1="38" x2="128" y2="84" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
    <line x1="145" y1="38" x2="156" y2="84" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
    <line x1="145" y1="38" x2="184" y2="84" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>

    <!-- Topic T1 -->
    <rect x="35" y="76" width="220" height="34" rx="4" fill="rgba(255,255,255,0.12)" stroke="rgba(255,255,255,0.5)" stroke-width="2"/>
    <text x="57" y="98" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="13" font-family="Arial, sans-serif">T1</text>
    <!-- Partition slots -->
    <rect x="90" y="84" width="20" height="18" rx="2" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
    <rect x="118" y="84" width="20" height="18" rx="2" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
    <rect x="146" y="84" width="20" height="18" rx="2" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
    <rect x="174" y="84" width="20" height="18" rx="2" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
    <!-- Lag bar for T1 partition 2 -->
    <rect class="lag-a2" x="148" y="102" width="16" height="0" rx="1" fill="rgba(255,255,255,0.05)"/>

    <!-- Curves: T1 → Service B1 (partitions 0,1) -->
    <path d="M 100,102 C 100,120 75,135 75,152" stroke="rgba(255,255,255,0.25)" stroke-width="1.5" fill="none"/>
    <path d="M 128,102 C 128,120 75,135 75,152" stroke="rgba(255,255,255,0.25)" stroke-width="1.5" fill="none"/>

    <!-- Curves: T1 → Service B2 (partitions 2,3) -->
    <path d="M 156,102 C 156,120 215,135 215,152" stroke="rgba(255,255,255,0.25)" stroke-width="1.5" fill="none"/>
    <path d="M 184,102 C 184,120 215,135 215,152" stroke="rgba(255,255,255,0.25)" stroke-width="1.5" fill="none"/>

    <!-- Service B1 -->
    <rect x="15" y="152" width="120" height="34" rx="4" fill="rgba(255,255,255,0.25)" stroke="rgba(255,255,255,0.6)" stroke-width="2"/>
    <text x="75" y="174" text-anchor="middle" fill="rgba(255,255,255,0.65)" font-size="12" font-family="Arial, sans-serif">Service B1</text>
    <rect class="process-b1" x="17" y="180" width="0" height="5" rx="1" fill="rgba(100,220,255,0.85)"/>
    <text x="75" y="200" text-anchor="middle" fill="rgba(255,255,255,0.4)" font-size="9" font-family="Arial, sans-serif">[p0, p1]</text>

    <!-- Service B2 -->
    <rect x="155" y="152" width="120" height="34" rx="4" fill="rgba(255,255,255,0.25)" stroke="rgba(255,255,255,0.6)" stroke-width="2"/>
    <text x="215" y="174" text-anchor="middle" fill="rgba(255,255,255,0.65)" font-size="12" font-family="Arial, sans-serif">Service B2</text>
    <rect class="process-b2" x="157" y="180" width="0" height="5" rx="1" fill="rgba(100,220,255,0.85)"/>
    <text x="215" y="200" text-anchor="middle" fill="rgba(255,255,255,0.4)" font-size="9" font-family="Arial, sans-serif">[p2, p3]</text>

    <!-- Curves: Service B1 → T2 -->
    <path d="M 75,186 C 75,207 100,220 100,236" stroke="rgba(255,255,255,0.25)" stroke-width="1.5" fill="none"/>
    <path d="M 75,186 C 75,207 128,220 128,236" stroke="rgba(255,255,255,0.25)" stroke-width="1.5" fill="none"/>
    <!-- Curves: Service B2 → T2 -->
    <path d="M 215,186 C 215,207 156,220 156,236" stroke="rgba(255,255,255,0.25)" stroke-width="1.5" fill="none"/>
    <path d="M 215,186 C 215,207 184,220 184,236" stroke="rgba(255,255,255,0.25)" stroke-width="1.5" fill="none"/>

    <!-- Topic T2 -->
    <rect x="35" y="228" width="220" height="34" rx="4" fill="rgba(255,255,255,0.12)" stroke="rgba(255,255,255,0.5)" stroke-width="2"/>
    <text x="57" y="250" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-size="13" font-family="Arial, sans-serif">T2</text>
    <!-- Partition slots -->
    <rect x="90" y="236" width="20" height="18" rx="2" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
    <rect x="118" y="236" width="20" height="18" rx="2" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
    <rect x="146" y="236" width="20" height="18" rx="2" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
    <rect x="174" y="236" width="20" height="18" rx="2" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
    <!-- Lag bar for T2 partition 3 -->
    <rect class="lag-b3" x="176" y="254" width="16" height="0" rx="1" fill="rgba(255,255,255,0.05)"/>

    <!-- Fan-in: T2 partitions → Consumer C -->
    <line x1="100" y1="254" x2="145" y2="304" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
    <line x1="128" y1="254" x2="145" y2="304" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
    <line x1="156" y1="254" x2="145" y2="304" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
    <line x1="184" y1="254" x2="145" y2="304" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>

    <!-- Consumer C -->
    <rect x="78" y="304" width="134" height="34" rx="4" fill="rgba(255,255,255,0.25)" stroke="rgba(255,255,255,0.6)" stroke-width="2"/>
    <text x="145" y="326" text-anchor="middle" fill="rgba(255,255,255,0.65)" font-size="13" font-family="Arial, sans-serif">Consumer C</text>

    <!-- Animated message dots -->

    <!-- Dot 0: route-p0 → Service B1 (white) -->
    <circle r="4" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" opacity="0">
        <animateMotion dur="8s" repeatCount="indefinite" begin="0s" calcMode="linear"
            keyPoints="0;0.23;0.23;0.50;0.50;0.76;0.76;1;1"
            keyTimes= "0;0.08;0.16;0.28;0.53;0.65;0.70;0.85;1">
            <mpath href="#route-p0"/>
        </animateMotion>
        <animate attributeName="opacity" dur="8s" repeatCount="indefinite" begin="0s"
            values="0;1;1;1;0" keyTimes="0;0.03;0.5;0.90;1"/>
    </circle>

    <!-- Dot 1: route-p2 → Service B2 (white) -->
    <circle r="4" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" opacity="0">
        <animateMotion dur="8s" repeatCount="indefinite" begin="1.3s" calcMode="linear"
            keyPoints="0;0.17;0.17;0.50;0.50;0.82;0.82;1;1"
            keyTimes= "0;0.08;0.16;0.28;0.53;0.65;0.70;0.85;1">
            <mpath href="#route-p2"/>
        </animateMotion>
        <animate attributeName="opacity" dur="8s" repeatCount="indefinite" begin="1.3s"
            values="0;1;1;1;0" keyTimes="0;0.03;0.5;0.90;1"/>
    </circle>

    <!-- Dot 2: route-p1 → Service B1 (white) -->
    <circle r="4" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" opacity="0">
        <animateMotion dur="8s" repeatCount="indefinite" begin="2.7s" calcMode="linear"
            keyPoints="0;0.18;0.18;0.50;0.50;0.81;0.81;1;1"
            keyTimes= "0;0.08;0.16;0.28;0.53;0.65;0.70;0.85;1">
            <mpath href="#route-p1"/>
        </animateMotion>
        <animate attributeName="opacity" dur="8s" repeatCount="indefinite" begin="2.7s"
            values="0;1;1;1;0" keyTimes="0;0.03;0.5;0.90;1"/>
    </circle>

    <!-- Dot 3: route-p3 → Service B2 (white) -->
    <circle r="4" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" opacity="0">
        <animateMotion dur="8s" repeatCount="indefinite" begin="4.0s" calcMode="linear"
            keyPoints="0;0.22;0.22;0.50;0.50;0.78;0.78;1;1"
            keyTimes= "0;0.08;0.16;0.28;0.53;0.65;0.70;0.85;1">
            <mpath href="#route-p3"/>
        </animateMotion>
        <animate attributeName="opacity" dur="8s" repeatCount="indefinite" begin="4.0s"
            values="0;1;1;1;0" keyTimes="0;0.03;0.5;0.90;1"/>
    </circle>

    <!-- Dot 4: route-p0 → Service B1 (white) -->
    <circle r="4" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" opacity="0">
        <animateMotion dur="8s" repeatCount="indefinite" begin="5.3s" calcMode="linear"
            keyPoints="0;0.23;0.23;0.50;0.50;0.76;0.76;1;1"
            keyTimes= "0;0.08;0.16;0.28;0.53;0.65;0.70;0.85;1">
            <mpath href="#route-p0"/>
        </animateMotion>
        <animate attributeName="opacity" dur="8s" repeatCount="indefinite" begin="5.3s"
            values="0;1;1;1;0" keyTimes="0;0.03;0.5;0.90;1"/>
    </circle>

    <!-- Dot 5: route-p2 → Service B2 (white) -->
    <circle r="4" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" opacity="0">
        <animateMotion dur="8s" repeatCount="indefinite" begin="6.7s" calcMode="linear"
            keyPoints="0;0.17;0.17;0.50;0.50;0.82;0.82;1;1"
            keyTimes= "0;0.08;0.16;0.28;0.53;0.65;0.70;0.85;1">
            <mpath href="#route-p2"/>
        </animateMotion>
        <animate attributeName="opacity" dur="8s" repeatCount="indefinite" begin="6.7s"
            values="0;1;1;1;0" keyTimes="0;0.03;0.5;0.90;1"/>
    </circle>
</svg>
